steps:
# substitutions needed in the gcloud submit command:
#   _LOCATION, _REPOSITORY, _IMAGE
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build',
          '-f',
          'dockerfiles/Dockerfile.extract_load',
          '-t',
          '${LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_EL}',
          '--build-arg', 'GCP_PROJECT_ID=${PROJECT_ID}',
          '--build-arg', 'LOCATION=${LOCATION}',
          '--build-arg', 'BQ_DATASET=${_BQ_DATASET}',
          '--build-arg', 'GCS_BUCKET=${_GCS_BUCKET}',
          '--build-arg', 'SCRIPT_DIR=${_SCRIPT_DIR}',
          '.' ]

- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build',
          '-f',
          'dockerfiles/Dockerfile.dbt',
          '-t',
          '${LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_IMAGE_T}',
          '--build-arg', 'GCP_PROJECT_ID=${PROJECT_ID}',
          '--build-arg', 'BQ_LOCATION=${LOCATION}',
          '--build-arg', 'BQ_DATASET=${_BQ_DATASET}',
          '--build-arg', 'HOST_PROJECT_DIR=${_HOST_PROJECT_DIR}',
          '--build-arg', 'TARGET=${_TARGET}',
          '.' ]

options:
    dynamic_substitutions: true

substitutions:
  # default values; PROJECT_ID and LOCATION are built-in
  _REPOSITORY: ${$ARTIFACT_REGISTRY}
  _BQ_DATASET: service_models
  _GCS_BUCKET: service-data-lake
  _SCRIPT_DIR: jobs/
  _HOST_PROJECT_DIR: dbt-core-service/
  _TARGET: prod
  _IMAGE_EL: extraction_load
  _IMAGE_T: dbt

# this step pushes to artifact registry
images: [
  '${LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_IMAGE_EL}',
  '${LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_IMAGE_T}'
]
